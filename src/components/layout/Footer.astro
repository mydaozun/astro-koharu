---
import FooterAnnouncementEntry from '@components/announcement/FooterAnnouncementEntry';
import { MAX_WIDTH } from '@constants/layout';
import { siteConfig } from '@constants/site-config';
import { getSiteStats } from '@lib/stats';
import { cn } from '@lib/utils';
import { Icon } from 'astro-icon/components';
import SakuraSVG from '../svg/SakuraSvg';

interface Props {
  className?: string;
}

const { className } = Astro.props;

const stats = await getSiteStats();
const currentYear = new Date().getFullYear();
const startYear = siteConfig?.startYear ?? currentYear;
---

<footer class={cn('mt-auto pb-6', className)}>
  <div class={cn('mx-auto flex flex-col items-center gap-3 px-6 md:pb-10 md:px-3', MAX_WIDTH.content)}>
    <!-- Announcements Entry -->
    <FooterAnnouncementEntry client:load />

    <!-- Site Stats -->
    <div class="text-muted-foreground flex flex-wrap items-center justify-center gap-6 text-sm md:gap-4">
      <button class="flex items-center gap-2 opacity-75 transition-opacity duration-300 hover:opacity-100" title="站点总字数">
        <Icon name="ri:file-text-line" class="h-4 w-4" />
        <span class="font-medium">{stats.formattedWords}</span>
        <span class="text-xs">字</span>
      </button>

      <div class="bg-muted-foreground/30 h-4 w-px"></div>

      <button class="flex items-center gap-2 opacity-75 transition-opacity duration-300 hover:opacity-100" title="站点阅读时长">
        <Icon name="ri:time-line" class="h-4 w-4" />
        <span class="font-medium">{stats.formattedTime}</span>
      </button>

      <div class="bg-muted-foreground/30 h-4 w-px"></div>

      <button class="flex items-center gap-2 opacity-75 transition-opacity duration-300 hover:opacity-100" title="文章总数">
        <Icon name="ri:article-line" class="h-4 w-4" />
        <span class="font-medium">{stats.postCount}</span>
        <span class="text-xs">篇</span>
      </button>
    </div>

    <!-- Busuanzi Stats -->
    <div class="text-muted-foreground flex flex-col items-center justify-center gap-2 text-sm">
      <!-- 今日统计 -->
      <div class="flex items-center justify-center gap-4">
        <span class="flex items-center gap-1 opacity-75 transition-opacity duration-300 hover:opacity-100">
          <Icon name="ri:time-line" class="h-4 w-4" />
          <span>今日总访问量</span>
          <span id="busuanzi_today_pv" class="font-medium">加载中...</span>
          <span class="text-xs">次</span>
        </span>
        <span class="opacity-50">|</span>
        <span class="flex items-center gap-1 opacity-75 transition-opacity duration-300 hover:opacity-100">
          <Icon name="ri:user-line" class="h-4 w-4" />
          <span>今日总访客数</span>
          <span id="busuanzi_today_uv" class="font-medium">加载中...</span>
          <span class="text-xs">人</span>
        </span>
      </div>

      <!-- 本站统计 -->
      <div class="flex items-center justify-center gap-4">
        <span class="flex items-center gap-1 opacity-75 transition-opacity duration-300 hover:opacity-100">
          <Icon name="ri:global-line" class="h-4 w-4" />
          <span>本站总访问量</span>
          <span id="busuanzi_site_pv" class="font-medium">加载中...</span>
          <span class="text-xs">次</span>
        </span>
        <span class="opacity-50">|</span>
        <span class="flex items-center gap-1 opacity-75 transition-opacity duration-300 hover:opacity-100">
          <Icon name="ri:team-line" class="h-4 w-4" />
          <span>本站总访客数</span>
          <span id="busuanzi_site_uv" class="font-medium">加载中...</span>
          <span class="text-xs">人</span>
        </span>
      </div>

      <!-- 本页统计 -->
      <div class="flex items-center justify-center gap-4">
        <span class="flex items-center gap-1 opacity-75 transition-opacity duration-300 hover:opacity-100">
          <Icon name="ri:file-line" class="h-4 w-4" />
          <span>本页总阅读量</span>
          <span id="busuanzi_page_pv" class="font-medium">加载中...</span>
          <span class="text-xs">次</span>
        </span>
        <span class="opacity-50">|</span>
        <span class="flex items-center gap-1 opacity-75 transition-opacity duration-300 hover:opacity-100">
          <Icon name="ri:user-smile-line" class="h-4 w-4" />
          <span>本页总访客数</span>
          <span id="busuanzi_page_uv" class="font-medium">加载中...</span>
          <span class="text-xs">人</span>
        </span>
      </div>
    </div>

<!-- 不蒜子计数 -->
<script async src="//cdn.busuanzi.cc/busuanzi/3.6.9/busuanzi.min.js"></script>
<!-- 不蒜子计数 -->

<!-- 不蒜子计数初始值纠正 -->
<script>
window.addEventListener('DOMContentLoaded', function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_value_site_pv"))
        {
            var pvElement = document.getElementById("busuanzi_value_site_pv");
            if (pvElement.textContent) {
                pvElement.textContent = parseInt(pvElement.textContent) + countOffset;
                clearInterval(int);
            }
        }                  
        if (document.getElementById("busuanzi_value_site_uv"))
        {
            var uvElement = document.getElementById("busuanzi_value_site_uv");
            if (uvElement.textContent) {
                uvElement.textContent = parseInt(uvElement.textContent) + countOffset;
                clearInterval(int); // 停止检测
            }
        }  
    }

});
</script>

    <!-- Copyright -->
    <div class="text-muted-foreground flex items-center gap-0.5 text-sm">
      <span class="opacity-75">©</span>
      <span class="font-medium opacity-75">{startYear}</span>
      {
        startYear !== currentYear && (
          <>
            <span class="opacity-50">-</span>
            <span class="font-medium opacity-75" itemprop="copyrightYear">
              {currentYear}
            </span>
          </>
        )
      }
      <SakuraSVG className="mx-1 size-5 animate-spin text-[#FFC0CB] duration-10000" />
      <span class="author font-medium opacity-75" itemprop="copyrightHolder">
        {siteConfig.name}
        {siteConfig?.alternate ? `@${siteConfig.alternate}` : ''}
      </span>
    </div>

    <!-- Powered By -->
    <div class="text-muted-foreground/80 flex items-center gap-2 text-xs">
      <span class="opacity-75">Powered by theme</span>
      <a
        href="https://github.com/mydaozun/astro-koharu"
        target="_blank"
        class="footer-link font-medium transition-all duration-300"
      >
        astro-koharu
      </a>
      <span class="opacity-50">·</span>
      <span class="opacity-75">Inspired by</span>
      <a
        href="https://github.com/mydaozun/astro-koharu"
        target="_blank"
        class="footer-link font-medium transition-all duration-300"
      >
        Shoka
      </a>
    </div>
  </div>
</footer>

<style>
  .footer-link {
    opacity: 0.75;
    position: relative;
  }

  .footer-link:hover {
    opacity: 1;
  }

  .footer-link::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 1px;
    background: currentColor;
    transition: width 0.3s ease;
  }

  .footer-link:hover::after {
    width: 100%;
  }
</style>
